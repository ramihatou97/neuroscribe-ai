<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScribe - Simple Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #0066CC;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #ddd;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        textarea:focus {
            outline: none;
            border-color: #0066CC;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0066CC, #0052A3);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        button.success {
            background: linear-gradient(135deg, #00A86B, #008C5A);
        }

        button.danger {
            background: linear-gradient(135deg, #DC143C, #C0102A);
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status.working {
            background: #d1ecf1;
            color: #0c5460;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        .buttons button {
            flex: 1;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† NeuroScribe - Simple Working Version</h1>

        <div id="status" class="status disconnected">
            üîë Checking API key...
        </div>

        <div class="grid">
            <!-- Left Panel: Input -->
            <div class="panel">
                <h2>üìù Clinical Transcript</h2>

                <div class="info">
                    <strong>Instructions:</strong> Type or paste your clinical encounter transcript below, then click "Generate Clinical Note"
                </div>

                <textarea
                    id="transcript"
                    placeholder="Enter or paste your clinical encounter transcript here...&#10;&#10;Include patient history, symptoms, examination findings, and any relevant clinical information."
                ></textarea>

                <button onclick="clearText()">üóëÔ∏è Clear</button>
            </div>

            <!-- Right Panel: Output -->
            <div class="panel">
                <h2>ü§ñ AI-Generated Documentation</h2>

                <button onclick="generate()" class="success" id="generateBtn">
                    ‚ö° Generate Clinical Note
                </button>

                <textarea
                    id="output"
                    placeholder="AI-generated clinical documentation will appear here..."
                    readonly
                ></textarea>

                <div class="buttons">
                    <button onclick="copyOutput()">üìã Copy</button>
                    <button onclick="downloadOutput()">üíæ Download</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get API key from localStorage
        let API_KEY = null;

        function loadAPIKey() {
            const encrypted = localStorage.getItem('neuroscribe_gemini_key');
            if (encrypted) {
                try {
                    API_KEY = atob(encrypted).split('').reverse().join('');
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = '‚úÖ API Key Loaded - Ready to Generate';
                    console.log('‚úÖ API key loaded:', API_KEY.substring(0, 15) + '...');
                    return true;
                } catch (e) {
                    console.error('Failed to decrypt key:', e);
                }
            }

            // No key found
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').innerHTML = '‚ùå No API Key - <a href="STATUS_CHECK.html" style="color: #721c24; text-decoration: underline;">Configure Now</a>';
            return false;
        }

        async function generate() {
            const transcript = document.getElementById('transcript').value.trim();

            if (!transcript) {
                alert('Please enter a clinical transcript first');
                return;
            }

            if (!API_KEY) {
                alert('API key not configured. Click "Configure Now" above.');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const output = document.getElementById('output');

            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            status.className = 'status working';
            status.textContent = 'üîÑ Analyzing transcript and generating documentation...';

            try {
                const prompt = `You are an expert neurosurgical documentation specialist. Analyze this clinical transcript and generate a comprehensive consultation note with the following sections:

# NEUROSURGICAL CONSULTATION NOTE

## CHIEF COMPLAINT
## HISTORY OF PRESENT ILLNESS
## PAST MEDICAL HISTORY
## PAST SURGICAL HISTORY
## MEDICATIONS
## ALLERGIES
## PHYSICAL EXAMINATION
- Vital Signs
- General Appearance
- Neurological Examination (Mental Status, Cranial Nerves, Motor, Sensory, Reflexes, Cerebellar, Gait)
## DIAGNOSTIC RESULTS
## ASSESSMENT
## PLAN
## ICD-10 CODES

Transcript:
${transcript}`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                role: 'user',
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                maxOutputTokens: 8192
                            }
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response generated';

                output.value = generatedText;
                status.className = 'status connected';
                status.textContent = '‚úÖ Documentation Generated Successfully!';
                console.log('‚úÖ Generated successfully');

            } catch (error) {
                console.error('Generation error:', error);
                output.value = `‚ùå Error: ${error.message}`;
                status.className = 'status disconnected';
                status.textContent = '‚ùå Generation Failed - Check console';
                alert(`Generation failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° Generate Clinical Note';
            }
        }

        function clearText() {
            if (confirm('Clear transcript?')) {
                document.getElementById('transcript').value = '';
            }
        }


        function copyOutput() {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('copy');
            alert('‚úÖ Copied to clipboard!');
        }

        function downloadOutput() {
            const text = document.getElementById('output').value;
            if (!text) {
                alert('No content to download');
                return;
            }

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clinical-note-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load API key on startup
        window.addEventListener('load', loadAPIKey);
    </script>
</body>
</html>
